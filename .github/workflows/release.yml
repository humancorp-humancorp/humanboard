name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build-macos:
    runs-on: macos-14  # Apple Silicon runner
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Build release
        run: cargo build --release
        env:
          RUSTFLAGS: "-Ctarget-feature=+aes,+sha2,+sha3,+neon"

      - name: Create app bundle and DMG
        run: |
          chmod +x build-app.sh
          ./build-app.sh

      - name: Calculate SHA256
        id: sha
        run: |
          SHA=$(shasum -a 256 Humanboard.dmg | awk '{print $1}')
          echo "sha256=$SHA" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA"

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Humanboard v${{ steps.version.outputs.version }}
          body: |
            ## Installation

            ### Homebrew (recommended)
            ```bash
            brew tap humancorp-humancorp/humanboard
            brew install --cask humanboard
            ```

            ### Manual Download
            1. Download `Humanboard.dmg` below
            2. Open the DMG and drag Humanboard to Applications
            3. First launch: Right-click → Open → Open (to bypass Gatekeeper)

            ---
            **SHA256:** `${{ steps.sha.outputs.sha256 }}`
          files: Humanboard.dmg
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Homebrew tap
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.TAP_UPDATE_TOKEN }}" \
            https://api.github.com/repos/humancorp-humancorp/homebrew-humanboard/dispatches \
            -d '{"event_type":"update-cask","client_payload":{"version":"${{ steps.version.outputs.version }}","sha256":"${{ steps.sha.outputs.sha256 }}"}}'
